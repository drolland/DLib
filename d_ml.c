#include "d_ml.h"
#include <stdio.h>
#include <assert.h>
#include <string.h>
#include <math.h>

void d_mat4_mul_mat4(mat4 res,mat4 a,mat4 b){   
    
    assert(res != a && res != b);
    
    res[0][0] = a[0][0] * b[0][0] + a[1][0] * b[0][1] + a[2][0] * b[0][2] + a[3][0] * b[0][3];
    res[0][1] = a[0][1] * b[0][0] + a[1][1] * b[0][1] + a[2][1] * b[0][2] + a[3][1] * b[0][3];
    res[0][2] = a[0][2] * b[0][0] + a[1][2] * b[0][1] + a[2][2] * b[0][2] + a[3][2] * b[0][3];
    res[0][3] = a[0][3] * b[0][0] + a[1][3] * b[0][1] + a[2][3] * b[0][2] + a[3][3] * b[0][3];
    
    res[1][0] = a[0][0] * b[1][0] + a[1][0] * b[1][1] + a[2][0] * b[1][2] + a[3][0] * b[1][3];
    res[1][1] = a[0][1] * b[1][0] + a[1][1] * b[1][1] + a[2][1] * b[1][2] + a[3][1] * b[1][3];
    res[1][2] = a[0][2] * b[1][0] + a[1][2] * b[1][1] + a[2][2] * b[1][2] + a[3][2] * b[1][3];
    res[1][3] = a[0][3] * b[1][0] + a[1][3] * b[1][1] + a[2][3] * b[1][2] + a[3][3] * b[1][3];
    
    res[2][0] = a[0][0] * b[2][0] + a[1][0] * b[2][1] + a[2][0] * b[2][2] + a[3][0] * b[2][3];
    res[2][1] = a[0][1] * b[2][0] + a[1][1] * b[2][1] + a[2][1] * b[2][2] + a[3][1] * b[2][3];
    res[2][2] = a[0][2] * b[2][0] + a[1][2] * b[2][1] + a[2][2] * b[2][2] + a[3][2] * b[2][3];
    res[2][3] = a[0][3] * b[2][0] + a[1][3] * b[2][1] + a[2][3] * b[2][2] + a[3][3] * b[2][3];

    res[3][0] = a[0][0] * b[3][0] + a[1][0] * b[3][1] + a[2][0] * b[3][2] + a[3][0] * b[3][3];
    res[3][1] = a[0][1] * b[3][0] + a[1][1] * b[3][1] + a[2][1] * b[3][2] + a[3][1] * b[3][3];
    res[3][2] = a[0][2] * b[3][0] + a[1][2] * b[3][1] + a[2][2] * b[3][2] + a[3][2] * b[3][3];
    res[3][3] = a[0][3] * b[3][0] + a[1][3] * b[3][1] + a[2][3] * b[3][2] + a[3][3] * b[3][3];

}

void d_mat4_mul_vec3(vec3 res, mat4 m, vec3 v){ 
    
    assert(res != v);
    
    res[0] = m[0][0] * v[0] + m[1][0] * v[1] + m[2][0] * v[2] + m[3][0];
    res[1] = m[0][1] * v[0] + m[1][1] * v[1] + m[2][1] * v[2] + m[3][1];
    res[2] = m[0][2] * v[0] + m[1][2] * v[1] + m[2][2] * v[2] + m[3][2];
    
}

void d_mat4_perspective(mat4 res, float fovy, float aspect_ratio, float near, float far){
    
    double f = 1/tan(fovy/2);
    
    res[0][0] = f / aspect_ratio;
    res[0][1] = 0;
    res[0][2] = 0;
    res[0][3] = 0;
    
    res[1][0] = 0;
    res[1][1] = f;
    res[1][2] = 0;
    res[1][3] = 0;
    
    res[2][0] = 0;
    res[2][1] = 0;
    res[2][2] = far/(far - near);
    res[2][3] = -far*near/(far - near);

    res[3][0] = 0;
    res[3][1] = 0;
    res[3][2] = 1;
    res[3][3] = 0;

}

void d_mat4_print(mat4 mat){
    for(int i = 0 ; i < 4 ; i++){
        printf("[");
        for(int j = 0; j < 3; j++)
            printf("%f|",mat[j][i]);
        printf("%f]\n",mat[3][i]);
    }
}